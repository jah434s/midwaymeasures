@{
    ViewBag.Title = "Admin";
}

<h2>@ViewBag.Title</h2>

<section class="row">
    <div class="col-md-3 well">
        <ul class="list-unstyled" id="peopleList">
            <li ng-repeat="person in people" class="admin-person-list-item">
                <a data-toggle="collapse" data-parent="#peopleList" href="[data-id='{{person.firstName}}{{person.lastName}}']" class="admin-person">
                   {{person.firstName}} {{person.lastName}}
                </a>
                <form class="collapse" data-id="{{person.firstName}}{{person.lastName}}" ng-submit="people.$save(person)">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" class="form-control" ng-model="person.firstName" />
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" class="form-control" ng-model="person.lastName" />
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" class="form-control" ng-model="person.email" />
                    </div>
                    <div class="form-group">
                        <label>Trello ID</label>
                        <input type="text" class="form-control" ng-model="person.trelloId" />
                    </div>
                    <div class="form-group">
                        <label>Team</label>
                        <select class="form-control" ng-model="person.team">
                            <option ng-repeat="team in teams" value="{{team.name}}">{{team.name}}</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select class="form-control" ng-model="person.status">
                            <option value="active">Active</option>
                            <option value="active">Inactive</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Submit</button>
                </form>
            </li>
        </ul>
    </div>
    <div class="col-md-8 col-md-offset-1">
        <section class="row">
            <div class="col-xs-6 result-section">
                <h2>Work Type Distribution</h2>
                <ul class="list-unstyled clearfix">
                    <li class="result-item" data-result-container>
                        <h3 data-team class="result-item-title">Web Production</h3>
                        @*<strong data-result class="result-item-value"></strong>*@
                        <canvas data-worktype-chart width="220" height="220"></canvas>
                    </li>
                </ul>
            </div>
            <div class="col-xs-6 result-section">
                <h2>People Per Card</h2>
                <dl data-people-per-card-list class="result-item"></dl>
            </div>
        </section>

    </div>
</section>


@section scripts {
    <script>

        // This gets worktype distribution by effort
        var effortsByWorkType = [];
        FB('cards').once('value', function (snapshot) {
            var cards = snapshot.val(),
                workTypes = [];
            Object.keys(cards).forEach(function (cardKey) {
                var card = cards[cardKey];
                if (workTypes.indexOf(card.workType) < 0) {
                    workTypes.push(card.workType);
                }
                var index = workTypes.indexOf(card.workType);
                if (typeof effortsByWorkType[index] == 'undefined') effortsByWorkType[index] = 0;
                if (typeof card.effort != 'undefined') {
                    effortsByWorkType[index] += parseFloat(card.effort);
                }
            });
            makePieChart(workTypes, effortsByWorkType, $('[data-worktype-chart]'));
        });

        //Get average people per card for each team
        FB('teams').on('child_added', function (team) {
            var peoplePerCard = [];
            FB('cards').orderByChild('team').equalTo(team.key()).on('value', function (cards) {
                $.each(Object.keys(cards.val()), function (index, card) {
                    var people = cards.val()[card].people;
                    if (people) {
                        peoplePerCard.push(Object.keys(cards.val()[card].people).length);
                    } else {
                        peoplePerCard.push(0);
                    }
                });
                var totalPeople = peoplePerCard.reduce(function (a, b) {
                    return a + b;
                });
                $('[data-people-per-card-list]').append('<dt><h3 class=result-item-title>' + team.key() + '</h3></dt><dd class=result-item-result>' + (totalPeople / peoplePerCard.length).toFixed(2) + '</dd>');
            });
        });

    </script>
}


