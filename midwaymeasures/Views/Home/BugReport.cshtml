@{
    ViewBag.Title = "Bug Report";
}

<div class="alert alert-success hidden" data-bug-submit-success>
    <a href="#" class="close" data-dismiss="alert">&times;</a>
    <strong>Success!</strong> Bug Report submitted.
</div>

<h2>@ViewBag.Title</h2>

<form data-bug="form">
    <label>
        Date Introduced (approximate)
        <input type="date" data-bug="date" required />
    </label>
    <label>
        Brief Description
        <textarea data-bug="description" required></textarea>
    </label>
    <fieldset data-bug="people">
        <legend>People Involved</legend>

    </fieldset>
    <label>
        Team
        <select data-team-list required>
            <option></option>
        </select>
    </label>
    <button type="submit" class="btn btn-primary">Submit Bug Report</button>
</form>

@section scripts {
    <script>
        //Get People from DB
        fbRootRef.child('people').orderByChild('status').equalTo('active').on('child_added', function (snapshot) {
            var person = snapshot.val();
            var name = person.firstName + ' ' + person.lastName;
            $('[data-bug="people"]').append('<label><input type=checkbox data-bug="person">' + name + '</label>');
        });

        //Handle form submission
        $('[data-bug=form]').on('submit', function (e) {
            e.preventDefault();
            var bug = {
                dateIntroduced: Date.parse($('[data-bug=date]').val()),
                description: $('[data-bug=description]').val(),
                people: {},
                team: $(this).find('[data-team-list]').val()
            }

            $('[data-bug=person]:checked').each(function (index, checkbox) {
                var person = $(checkbox).parents('label').first().text();
                bug.people[person] = true;
            });

            //add defect to DB
            FB.defects.push(bug, function (error) {
                if (error) {
                    alert(error);
                } else {
                    $('[data-bug-submit-success]').removeClass('hidden');
                    $('[data-bug=form]')[0].reset();

                    //After the defect is added...
                    FB.defects.limitToLast(1).on('child_added', function (defect) {
                        //create defect reference
                        var defectObj = {};
                        defectObj[defect.key()] = true;

                        //add defect reference to iteration
                        FB.iterations.orderByChild('endDate').startAt(defect.val().dateIntroduced).limitToFirst(1).on('child_added', function (iteration) {
                            FB.iterations.child(iteration.val().endDate).child(defect.val().team).child('defects').update(defectObj, fbCallback);
                        });

                        //add defect reference to person
                        $.each(Object.keys(defect.val().people), function (index, person) {
                            FB.people.child(person).child('defects').update(defectObj, fbCallback);
                        });

                        //add defect reference to team
                        FB.teams.child(defect.val().team).child('defects').update(defectObj, fbCallback);

                    });
                }
            });
        });

    </script>
}
